---
title: "regis"
author: "regis andreoli"
date: "1/31/2022"
output:
  html_document:
    toc: yes
    toc_float: no
    toc_depth: 4
    number_sections: yes
  pdf_document:
    toc: yes
    toc_depth: '4'
---

````{r, echo= FALSE}
# load library
library(rstudioapi)
library(ggplot2)
library(gridExtra)
library(dplyr)
library(caret)
library(GGally)
library(mgcv)
library(lubridate)
```

# Load Data
````{r, echo=FALSE}
# identify and set directory, then read data from csv
setwd(dirname(getActiveDocumentContext()$path))
df_weather <- read.csv("./data/weather.csv",header=TRUE,sep =",",comment.char ="#")
df_plantA <- read.csv("./data/A.csv",header=TRUE,sep =",",comment.char ="#")
df_plantB <- read.csv("./data/B.csv",header=TRUE,sep =",",comment.char ="#")
df_plantC <- read.csv("./data/C.csv",header=TRUE,sep =",",comment.char ="#")
`````

# Data preparation
```{r}
df_weather$local_time <- as.POSIXct(df_weather$local_time,tz="GMT",format="%Y-%m-%d %H:%M")
df_plantA$Timestamp <- as.POSIXct(df_plantA$Timestamp,tz="GMT",format="%Y-%m-%d %H:%M:%S")
df_plantB$Timestamp <- as.POSIXct(df_plantB$Timestamp,tz="GMT",format="%Y-%m-%d %H:%M:%S")
df_plantC$Timestamp <- as.POSIXct(df_plantC$Timestamp,tz="GMT",format="%Y-%m-%d %H:%M:%S")
#df_weather %>% rename(datetime = local_time,)
```

```{r}
df_plantA_resample <- df_plantA %>%
  mutate(datetime = floor_date(Timestamp, "1 hour")) %>%
  group_by(datetime) %>%
  summarise(across(Generation_kW:Overall_Consumption_Calc_kW, sum))

str(df_plantA_resample)
```

#Visual analysis
First visual analysis of the data. complemented by a gam smoother.
```{r}
ggplot(data = df_plantA_resample,
  mapping = aes(y = Generation_kW, x = datetime)) +
  geom_point(size = 1, color = "grey69") +
  geom_smooth(method = "gam", color = "cornflowerblue")
```

# Time Series Analysis
Convert data set into time series object. As the data has an hourly resolution, the time repetition interval is set to 24, which correspond to a seasonality of one day.
```{r}
library(forecast)

ts_1 <- ts((df_plantA_resample$Generation_kW), deltat = 1/24)
train <- window(ts_1, start = 1, end = 250)
fit <- auto.arima(train)
```

Plot the time series with the prediction.
```{r}
fc <- predict(fit, n.ahead = 115*24)
plot(ts_1, lty=3, size = 0.1)
lines(train, lwd=1)
lines(fc$pred, lwd=2, col="red", size = 0.01)
#lines(fc$pred+fc$se*1.96, col="red")
#lines(fc$pred-fc$se*1.96, col="red")
```

Plot the decomposition of the time series with the function stl().
```{r}
decomp<-stl(ts_1, s.window = 1/24, t.window = 365)
plot(decomp)
```


# Second Time Series Analysis - Manipulated 
Some artificial years are added to the time series, to be able to capture seasonal effects (year).

## Data preparation
```{r}
df_plantA_resample_2 <- df_plantA %>%
  mutate(datetime = floor_date(Timestamp, "24 hour")) %>%
  group_by(datetime) %>%
  summarise(across(Generation_kW:Overall_Consumption_Calc_kW, sum))

ts_2 <- ts((df_plantA_resample_2$Generation_kW), start = c(2019), deltat = 1/365)
```

Plot time series of one year with a gam smoother.
```{r}
ggplot(data = df_plantA_resample_2,
  mapping = aes(y = Generation_kW, x = datetime)) +
  geom_point(size = 1, color = "grey69") +
  geom_smooth(method = "gam", color = "cornflowerblue")
```

Add random noise to first time series, in order togenerate new artificial years.
```{r}
ts_artif_1 <- {jitter(ts_2, factor=500, amount = NULL)}
ts_artif_2 <- {jitter(ts_2, factor=500, amount = NULL)}
head(ts_2)
head(ts_artif_1)
head(ts_artif_2)
```

Set negative values to zero, as due to the nature of the data, negative values should't occure.
```{r}
ts_artif_1[][ts_artif_1[] < 0] <- 0
ts_artif_2[][ts_artif_2[] < 0] <- 0
```

Create time series of several years, starting with real data year and two artificial years.
```{r}
ts_artificial <- ts(c(ts_2, ts_artif_1, ts_artif_2), start = c(2019), deltat = 1/365)
str(ts_artificial)
```

Plot decomposition of the time series with the function stl().
```{r}
decomp<-stl(ts_artificial, s.window = 365)
plot(decomp)
```

Train model with the first two years of the time series. To train the model, the auto.arima function is made use of.
```{r}
train_2 <- window(ts_artificial, start = 2019, end = 2020)
fit_2 <- auto.arima(train_2)
```


# Artificial time series - new attemp: use of gam model as base and normally distributed noise

```{r}
df_artif <- data.frame(time = (1:365), generation_kw = df_plantA_resample_2$Generation_kW)
```


```{r}
rnorm(365, c(5,100), sd = 1.5)
```

```{r}
gam_model <- gam(generation_kw ~ time, data = df_artif)
```

```{r}
gam_prediciton <- predict_gam(gam_model, length_out = 1)
```



Plot time series of one year with a gam smoother.
```{r}
ggplot(data = gam_prediciton,
  mapping = aes(y = fit, x = time)) +
  geom_point(size = 1, color = "grey69") +
  geom_smooth(method = "gam", color = "cornflowerblue")
```

```{r}
saved <- ggplot(data = df_artif,
  mapping = aes(y = generation_kw, x = time)) +
  geom_point(size = 1, color = "grey69") +
  geom_smooth(method = "gam", color = "cornflowerblue")
```




















